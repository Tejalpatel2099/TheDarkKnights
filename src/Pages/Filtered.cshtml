@page
@model RamenRatings.WebSite.Pages.FilteredModel
@{
    ViewData["Title"] = "Filtered Results";
}

<h2>Filtered Results</h2>

<form method="get">
    <div class="row">
        <!--Filter Brands with drop down form field-->
        <div class="form-group col-md-3">
            <label for="SelectedBrands">Brands</label>
            <select id="SelectedBrands" name="SelectedBrands" class="form-control" multiple>
                @foreach (var brand in Model.AllBrands)
                {
                    <option value="@brand" selected="@(Model.SelectedBrands?.Contains(brand) == true)">
                        @brand
                    </option>
                }
            </select>
        </div>

        <!--Filter styles with a drop down form field-->
        <div class="form-group col-md-3">
            <label for="SelectedStyle">Style</label>
            <select id="SelectedStyle" name="SelectedStyle" class="form-control">
                <option value="">-- All Styles --</option>
                @foreach (var style in Model.AllStyles)
                {
                    <option value="@style" selected="@(style == Model.SelectedStyle)">
                        @style
                    </option>
                }
            </select>
        </div>

        <!--Rating range slider-->
        <div class="form-group col-md-3">
            <label>Rating Range: <span id="ratingRangeText">1 - 5</span></label>
            <div id="ratingSlider"></div>
            <input type="hidden" id="MinRating" name="MinRating" />
            <input type="hidden" id="MaxRating" name="MaxRating" />
        </div>

        <!--Sort by dropdown-->
        <div class="form-group col-md-3">
            <label for="SortOption">Sort By</label>
            <select id="SortOption" name="SortOption" class="form-control">
                <option value="">-- No Sorting --</option>
                <option value="BrandAsc" selected="@(Model.SortOption == "BrandAsc")">Brand (A-Z)</option>
                <option value="BrandDesc" selected="@(Model.SortOption == "BrandDesc")">Brand (Z-A)</option>
                <option value="RatingAsc" selected="@(Model.SortOption == "RatingAsc")">Rating (Low to High)</option>
                <option value="RatingDesc" selected="@(Model.SortOption == "RatingDesc")">Rating (High to Low)</option>
            </select>
        </div>
    </div>

    <div class="mt-3">
        <button type="submit" class="btn btn-primary">Apply Filter</button>
        <a href="/Filtered" class="btn btn-outline-secondary">Clear Filters</a>
    </div>
</form>

<hr />

@if (Model.Products.Any())
{
    <div class="row row-cols-1 row-cols-md-3 g-4">
        @foreach (var product in Model.Products)
        {
            <a asp-page="/Details" asp-route-id="@product.Number" class="text-decoration-none text-dark">
                <div class="col">
                    <div class="card h-100 shadow-sm">
                        <img src="@product.img" class="card-img-top" alt="@product.Variety" style="height: 200px; object-fit: cover;">
                        <div class="card-body">
                            <h5 class="card-title">@product.Brand</h5>
                            <p class="card-text"><strong>@product.Variety</strong></p>
                            <p class="card-text">
                                <span class="text-muted">@product.Style</span><br />
                                <span class="text-muted">Country: @product.Country</span><br />
                                <span class="text-warning">Rating: @(product.Ratings?.FirstOrDefault() ?? 0)/5</span>
                            </p>
                        </div>
                    </div>
                </div>
            </a>
        }
    </div>
}
else
{
    <p>No products match the selected filters.</p>
}

<a class="btn btn-secondary mt-3" href="/">Back to Index</a>

<script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.js"></script>
<script>
    var slider = document.getElementById('ratingSlider');
    var minInput = document.getElementById('MinRating');
    var maxInput = document.getElementById('MaxRating');
    var rangeText = document.getElementById('ratingRangeText');

    const urlParams = new URLSearchParams(window.location.search);
    const min = parseFloat(urlParams.get("MinRating")) || 1;
    const max = parseFloat(urlParams.get("MaxRating")) || 5;

    noUiSlider.create(slider, {
        start: [min, max],
        connect: true,
        range: { 'min': 1, 'max': 5 },
        step: 0.1,
        format: { to: value => value.toFixed(1), from: value => parseFloat(value) }
    });

    slider.noUiSlider.on('update', function (values) {
        minInput.value = values[0];
        maxInput.value = values[1];
        rangeText.innerText = `${values[0]} - ${values[1]}`;
    });
</script>
